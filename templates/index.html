<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat — Aplegoetia</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    #chatBox {
      max-width: 700px;
      margin: 2rem auto;
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
    }

    #messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 0.5rem;
      background: #f8f8f8
    }

    .message {
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      background: #e9e9ff
    }

    #composer {
      display: flex;
      gap: 8px;
      margin-top: 8px
    }

    #composer input {
      flex: 1;
      padding: 8px
    }
  </style>
</head>

<body>{% extends "headFoot.html" %}

{% block title %}Chat — Aplegoetia{% endblock %}

{% block content %}
  <div id="chatBox">
    <h1>Chat</h1>
    <div id="messages" aria-live="polite"></div>
    <div id="controls" style="display:flex;gap:8px;margin-top:8px;align-items:center;">
      <input id="adminTokenInput" placeholder="Admin token (optional)" type="password" style="width:180px;padding:6px">
    </div>
    <div id="composer">
      <input id="messageInput" placeholder="Type a message" autocomplete="off">
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <div style="max-width:700px;margin:0.5rem auto;display:flex;justify-content:flex-end;align-items:center;">
    <div style="font-size:12px;color:#666">Admin delete requires correct token.</div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='chat.js') }}"></script>
  <script>
    // Sync chat username with the one from localStorage
    const username = localStorage.getItem("USERNAME") || "Anonymous";
    document.addEventListener("DOMContentLoaded", () => {
      const msgInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const messagesDiv = document.getElementById("messages");

      async function loadMessages() {
        const res = await fetch('/messages');
        const data = await res.json();
        messagesDiv.innerHTML = '';
        data.forEach(m => {
          const div = document.createElement('div');
          div.classList.add('message');
          div.textContent = `${m.username}: ${m.content}`;
          messagesDiv.appendChild(div);
        });
      }

      async function sendMessage() {
        const content = msgInput.value.trim();
        if (!content) return;
        await fetch('/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, content })
        });
        msgInput.value = '';
        loadMessages();
      }

      sendBtn.addEventListener('click', sendMessage);
      loadMessages();
    });
  </script>
{% endblock %}
</div>

      </div>
    </div>
  </header>
  <div id="chatBox">
    <h1>Chat</h1>
    <div id="messages" aria-live="polite"></div>
    <div id="controls" style="display:flex;gap:8px;margin-top:8px;align-items:center;">
      <input id="usernameInput" placeholder="Your name (optional)" style="width:180px;padding:6px">
      <input id="adminTokenInput" placeholder="Admin token (optional)" type="password" style="width:180px;padding:6px">
    </div>
    <div id="composer">
      <input id="messageInput" placeholder="Type a message" autocomplete="off">
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <div style="max-width:700px;margin:0.5rem auto;display:flex;justify-content:flex-end;align-items:center;">
    <div style="font-size:12px;color:#666">Admin delete requires correct token.</div>
  </div>
  <script src="{{ url_for('static', filename='chat.js') }}"></script>
</body>

</html>
